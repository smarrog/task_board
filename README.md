# Техническое задание: Task Board

## 1. Описание задачи

Необходимо разработать бэкенд для веб-приложения управления задачами (аналог Trello). Система должна позволять пользователям создавать доски, колонки и задачи, а также управлять ими (перемещать задачи между колонками).

## 2. Стек технологий
- **Язык:** Golang
- **СУБД:** PostgreSQL (основное хранилище), Redis (кэш)
- **Брокер сообщений:** Kafka
- **Транспорт:** HTTP (Fiber) для внешнего мира, gRPC для общения сервисов.
- **Библиотеки:**
    - HTTP: gofiber/fiber
    - Logging: rs/zerolog
    - DB: jackc/pgx/v5
    - Redis: redis/go-redis/v9
    - Kafka: segmentio/kafka-go
    - Testing: testify, mockery

## 3. Архитектура системы
Система состоит из 4-х сервисов, разворачиваемых в Docker
1. **API Gateway**
    - Единая точка входа (HTTP).
    - Маршрутизация запросов к микросервисам.
    - Преобразование HTTP -> gRPC и обратно.
    - Middleware для валидации JWT токена.
2. **Auth Service**
    - Регистрация и аутентификация (Login).
    - Выпуск JWT токенов (Access).
    - Хранение данных пользователей (id, email, password, username).
3. **Board Service** (Ядро системы)
    - CRUD операции для Досок, Колонок и Задач.
    - Логика перемещения задач между колонками.
    - Кэширование состояния доски в Redis.
    - Генерация событий изменений (TaskCreated, TaskMoved и т.д.) через паттерн Transactional Outbox.
4. **Notification Service**
    - Чтение событий из Kafka.
    - Имитация отправки уведомлений (логирование сообщения в консоль: «Email отправлен пользователю X: Задача Y обновлена»).
    - Сохранение истории уведомлений в БД.

## 4. Функциональные требования и данные
Необходимо самостоятельно спроектировать схему БД и API контракты, обеспечив хранение и обработку следующих сущностей:
### 4.1. Пользователи (Auth Service)
- **Сущность:** ID, email, username, password (hash).
- **Функции:** Регистрация, вход.

### 4.2. Доски (Board Service)
- **Сущность:** ID, название, описание, владелец.

- **Сущности внутри:**
    - **Колонки:** привязаны к доске, имеют порядок (position).
    - **Задачи:** привязаны к колонке, имеют заголовок, описание, исполнителя и порядок внутри колонки.
        
- **Функции:**
    - Полный CRUD для досок, колонок, задач.
    - Перемещение задачи (смена колонки и/или позиции).
    - Получение полной структуры доски (Board -> Columns -> Tasks) одним запросом (с использованием кэша).

### 4.3. События и Уведомления (Notification Service)
- **Триггеры:** Создание задачи, Обновление задачи, Перемещение задачи. 
- **Функции:** При возникновении события в Board Service, Notification Service должен получить его и сохранить запись о том, что уведомление было "отправлено".
    

## 5. Технические требования
1. **Коммуникация:**
    - Внешний API: REST JSON.
    - Межсервисное взаимодействие: строго **gRPC**.
2. **Архитектура кода:**
    - **Clean Architecture:** Четкое разделение на слои (Handler -> Usecase -> Repository/Domain).
    - **SOLID:** Соблюдение принципов, использование интерфейсов для инверсии зависимостей.
3. **Кэширование (Redis):**
    - Метод GetBoard должен пытаться читать данные из Redis.
    - При любом изменении на доске (создание таска, перемещение и т.д.) кэш этой доски должен инвалидироваться (удаляться).  
4. **Event Driven (Kafka + Outbox):**
    - **Строго:** Использование паттерна **Transactional Outbox**.
    - При изменении задачи в транзакции БД сохраняется само изменение И запись в таблицу outbox_events.
    - Отдельный процесс (goroutine) вычитывает события из БД и пушит их в Kafka.
    - Прямая отправка в Kafka из HTTP-хендлера запрещена.    
5. **Безопасность:**
    - Пароли хешируются.
    - Все эндпоинты (кроме Auth) защищены JWT.

## 6. План реализации
Рекомендуется выполнять работу поэтапно:
1. **Auth Service:** Реализовать регистрацию/логин, БД пользователей, генерацию JWT, proto-контракты и gRPC сервер.
2. **API Gateway:** Настроить Fiber, JWT middleware и проксирование запросов в Auth Service.    
3. **Board Service ч.1 CRUD:** Реализовать CRUD, БД, gRPC методы. 
4. **Board Service ч.2 Gateway connection:** Подключить Board Service к Gateway. На стороне gateway реализовать handlers и routes. Реализовать маппинг из protobuf в JSON.
5. **Board service ч.3 Кэширование:** Добавить слой Redis в Board Service для чтения досок.
6. **Board service ч.4 Асинхронность:** Реализовать таблицу outbox, воркер для отправки в Kafka и консьюмер в Notification Service.
7. **Notifications service:** Реализовать консьюмера из Kafka, настроить логирование и вывод сообщений из Kafka в консоль
8. **Tests (опционально):** Покрыть юнит-тестами слой бизнес-логики (Usecase), написать интеграционные тесты для основных хендлеров, проверить обработку ошибок.
    

## 7. Критерии приемки
- Приложение запускается одной командой (docker-compose up).
- Работают сценарии: Регистрация -> Создание доски -> Создание задачи -> Перемещение задачи.
- При перемещении задачи в логах Notification Service появляется запись.
- Код читаем, разбит на слои, отсутствуют хардкод-конфигурации (использовать переменные окружения или YAML файлы).